{% extends "base.html" %}

{% block content %}
<div class="glass-card">
    <h2 style="margin-top: 0; color: var(--deep-pink);">ğŸ›¡ï¸ è§„åˆ™ç®¡ç†</h2>

    <div style="background: rgba(255,255,255,0.4); padding: 15px; border-radius: 10px; margin-bottom: 20px;">
        <h4>â• æ·»åŠ æ–°è§„åˆ™ (æ­£åˆ™)</h4>
        <form action="/rules/add" method="post" style="display: flex; gap: 10px; flex-wrap: wrap;">
            <select name="rule_type" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="message_content">æ¶ˆæ¯å†…å®¹</option>
                <option value="username">ç”¨æˆ·å</option>
                <option value="is_command">æ˜¯å¦ä¸ºå‘½ä»¤</option>
                <option value="is_forwarded">æ˜¯å¦ä¸ºè½¬å‘</option>
            </select>
            <input type="text" name="pattern" placeholder="æ­£åˆ™æ¨¡å¼ (ä¾‹å¦‚: ^/start)" required
                style="flex: 1; padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
            <select name="action" style="padding: 10px; border-radius: 8px; border: 1px solid #ddd;">
                <option value="block">æ‹¦æˆª (æç¤º)</option>
                <option value="drop">ä¸¢å¼ƒ (é™é»˜)</option>
                <option value="allow">æ”¾è¡Œ (ç™½åå•)</option>
            </select>
            <button type="submit" class="btn">æ·»åŠ </button>
        </form>
    </div>

    <div style="overflow-x: auto;">
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>ç±»å‹</th>
                    <th>æ¨¡å¼</th>
                    <th>åŠ¨ä½œ</th>
                    <th>çŠ¶æ€</th>
                    <th>æ“ä½œ</th>
                </tr>
            </thead>
            <tbody>
                {% for rule in rules %}
                <tr>
                    <td>{{ rule.id }}</td>
                    <td>{{ rule.rule_type }}</td>
                    <td><code style="background: #eee; padding: 2px 5px;">{{ rule.pattern }}</code></td>
                    <td>
                        {% if rule.action == 'block' %}<span style="color:red">æ‹¦æˆª</span>
                        {% elif rule.action == 'drop' %}<span style="color:gray">ä¸¢å¼ƒ</span>
                        {% else %}<span style="color:green">æ”¾è¡Œ</span>{% endif %}
                    </td>
                    <td>
                        <form action="/rules/toggle" method="post" style="display:inline;">
                            <input type="hidden" name="rule_id" value="{{ rule.id }}">
                            {% if rule.is_active %}
                            <button type="submit"
                                style="background: none; border: none; cursor: pointer; font-size: 1.2em;"
                                title="ç‚¹å‡»ç¦ç”¨">âœ…</button>
                            {% else %}
                            <button type="submit"
                                style="background: none; border: none; cursor: pointer; font-size: 1.2em;"
                                title="ç‚¹å‡»å¯ç”¨">âŒ</button>
                            {% endif %}
                        </form>
                    </td>
                    <td>
                        <button class="btn"
                            style="padding: 5px 10px; font-size: 0.8em; background: linear-gradient(45deg, #a8edea, #fed6e3); color: #555;"
                            onclick="openEditModal('{{ rule.id }}', '{{ rule.rule_type }}', '{{ rule.pattern }}', '{{ rule.action }}')">
                            ç¼–è¾‘
                        </button>
                        <form action="/rules/delete" method="post" style="display:inline;">
                            <input type="hidden" name="rule_id" value="{{ rule.id }}">
                            <button type="submit" class="btn btn-danger"
                                style="padding: 5px 10px; font-size: 0.8em;">åˆ é™¤</button>
                        </form>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Edit Modal -->
<div id="editModal"
    style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; justify-content: center; align-items: center;">
    <div class="glass-card" style="background: rgba(255, 255, 255, 0.9); width: 90%; max-width: 500px;">
        <h3 style="margin-top: 0;">ç¼–è¾‘è§„åˆ™</h3>
        <form action="/rules/update" method="post">
            <input type="hidden" id="edit_rule_id" name="rule_id">

            <div style="margin-bottom: 15px;">
                <label>ç±»å‹:</label><br>
                <select id="edit_rule_type" name="rule_type" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="message_content">æ¶ˆæ¯å†…å®¹</option>
                    <option value="username">ç”¨æˆ·å</option>
                    <option value="is_command">æ˜¯å¦ä¸ºå‘½ä»¤</option>
                    <option value="is_forwarded">æ˜¯å¦ä¸ºè½¬å‘</option>
                </select>
            </div>

            <div style="margin-bottom: 15px;">
                <label>æ¨¡å¼:</label><br>
                <input type="text" id="edit_pattern" name="pattern" required
                    style="width: 95%; padding: 8px; margin-top: 5px;">
            </div>

            <div style="margin-bottom: 20px;">
                <label>åŠ¨ä½œ:</label><br>
                <select id="edit_action" name="action" style="width: 100%; padding: 8px; margin-top: 5px;">
                    <option value="block">æ‹¦æˆª (æç¤º)</option>
                    <option value="drop">ä¸¢å¼ƒ (é™é»˜)</option>
                    <option value="allow">æ”¾è¡Œ (ç™½åå•)</option>
                </select>
            </div>

            <div style="text-align: right;">
                <button type="button" class="btn" onclick="closeEditModal()"
                    style="background: #ccc; margin-right: 10px;">å–æ¶ˆ</button>
                <button type="submit" class="btn">ä¿å­˜</button>
            </div>
        </form>
    </div>
</div>

<script>
    function openEditModal(id, type, pattern, action) {
        document.getElementById('edit_rule_id').value = id;
        document.getElementById('edit_rule_type').value = type;
        document.getElementById('edit_pattern').value = pattern;
        document.getElementById('edit_action').value = action;

        document.getElementById('editModal').style.display = 'flex';
    }

    function closeEditModal() {
        document.getElementById('editModal').style.display = 'none';
    }

    // Close if clicked outside
    window.onclick = function (event) {
        if (event.target == document.getElementById('editModal')) {
            closeEditModal();
        }
    }
</script>
{% endblock %}